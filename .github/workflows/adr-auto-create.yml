name: ADR Auto Create from Issue

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

concurrency:
  group: adr-create-${{ github.event.issue.number }}
  cancel-in-progress: false


jobs:
  create-adr-md:
    if: github.event.label.name == 'adr:accepted'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract issue fields
        id: x
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const number = issue.number;
            const titleText = (issue.title || "").trim();
            const body = issue.body || "";
            
            // heading escape + storage pathë§Œ íŒŒì‹±(ë””ë ‰í† ë¦¬ ê²°ì •ì„ ìœ„í•´ ìµœì†Œí•œë§Œ)
            const esc = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            function extractField(heading) {
              const h = esc(String(heading).trim());
              const re = new RegExp(`^###\\s+${h}\\s*\\n([\\s\\S]*?)(?=\\n###\\s|$)`, 'm');
              const m = body.match(re);
              return m ? m[1].trim() : "";
            }
            const normalize = (v) => {
              const s = (v || "").trim();
              return /^_?No response_?$/i.test(s) ? "" : s;
            };
            
            // ì €ì¥ ìœ„ì¹˜ë§Œ ì½ì–´ì„œ ë””ë ‰í† ë¦¬/ID prefix ê²°ì •
            const STORAGE_HEADING = "ì €ì¥ ìœ„ì¹˜ (Storage Path)";
            let storagePath = normalize(extractField(STORAGE_HEADING)) || "org";
            storagePath = storagePath.split("\n").map(s=>s.trim()).filter(Boolean)[0] || "org";
            
            const mapDir = (v) => {
              switch (v) {
                case 'org':          return { dir: 'docs/adr/org',               idPrefix: 'O-ADR' };
                case 'vref-be':      return { dir: 'docs/adr/repos/vref-be',     idPrefix: 'R-ADR-vref-be' };
                case 'vref-fe':      return { dir: 'docs/adr/repos/vref-fe',     idPrefix: 'R-ADR-vref-fe' };
                case 'vref-config':  return { dir: 'docs/adr/repos/vref-config', idPrefix: 'R-ADR-vref-config' };
                case 'vref-infra':   return { dir: 'docs/adr/repos/vref-infra',  idPrefix: 'R-ADR-vref-infra' };
                case 'etc':          return { dir: 'docs/adr/repos/etc',         idPrefix: 'R-ADR-etc' };
                default:             return { dir: 'docs/adr/org',               idPrefix: 'O-ADR' };
              }
            };
            const { dir, idPrefix } = mapDir(storagePath);
            
            // íŒŒì¼ëª…/ID/ë‚ ì§œ
            const now = new Date();
            const year = now.getFullYear();
            const date = now.toISOString().slice(0,10);
            const adrId = `${idPrefix}-${year}-${String(number).padStart(4,'0')}`;
            
            // slugëŠ” ì œëª© ê¸°ì¤€(ìš”ì•½ ë¯¸ì‚¬ìš©)
            const slug = (titleText || `${storagePath}-proposal`)
              .toLowerCase()
              .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
              .replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '')
              .slice(0, 80) || 'proposal';
            
            const filename = `${dir}/${adrId}-${slug}.md`;
            
            // ë©”íƒ€ ë°ì´í„° + ì´ìŠˆ ë°”ë”” ì›ë¬¸ ìœ ì§€ + í•˜ë‹¨ ì•ˆë‚´(í‘œì‹œìš©)
            const md = `# ${adrId}: ${titleText}
            
            - **Status**: Accepted
            - **Date**: ${date}
            - **Discussion**: #${number}
            - **Scope**: ${storagePath === 'org' ? 'Org' : 'Repo'}
            - **Related**: -
            
            ---
            
            ${body.trim()}
            
            ---
            
            > Tracking issue: #${number}
            `;
            
            core.setOutput('filename', filename);
            core.setOutput('content', md);
            core.setOutput('branch', `adr/${adrId}`);
      - name: Create branch & commit
        env:
          FILENAME: ${{ steps.x.outputs.filename }}
          CONTENT: ${{ steps.x.outputs.content }}
          BRANCH:   ${{ steps.x.outputs.branch }}
        run: |
          set -euo pipefail
          git fetch origin --prune

          # í•­ìƒ ìµœì‹  mainì„ ë² ì´ìŠ¤ë¡œ ì‹œì‘
          git checkout -B tmp/adr-base origin/main
          
          # ì‘ì—… ë¸Œëœì¹˜ ë§Œë“¤ê¸°/ê°±ì‹ 
          if git ls-remote --exit-code --heads origin "$BRANCH" >/dev/null 2>&1; then
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git rebase --rebase-merges --onto origin/main "$(git merge-base origin/main "$BRANCH")" "$BRANCH" || true
          else
            git checkout -B "$BRANCH" origin/main
          fi

          # í˜¹ì‹œ ìŠ¤í…Œì´ì§•ë˜ì–´ ìˆì„ì§€ ëª¨ë¥¼ ì›Œí¬í”Œë¡œ ë³€ê²½ ì œê±°(ë³´ìˆ˜ì )
          git restore --staged .github/workflows || true
          git checkout -- .github/workflows || true

          mkdir -p "$(dirname "$FILENAME")"
          printf "%s" "$CONTENT" > "$FILENAME"

          # ìƒíƒœ í™•ì¸(ë””ë²„ê·¸)
          git status --porcelain

          git add "$FILENAME"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ë³€ê²½ ì—†ìœ¼ë©´ ì»¤ë°‹ ìƒëµ
          git diff --cached --quiet || git commit -m "chore(adr): add/update ${FILENAME}"

          # ê¸°ë³¸ í‘¸ì‹œ â†’ ì‹¤íŒ¨ ì‹œ with-leaseë¡œ í´ë°±
          git push --set-upstream origin "$BRANCH" || git push --force-with-lease origin "$BRANCH"

      - name: Open PR
        uses: actions/github-script@v7
        with:
          script: |
            const head = process.env.BRANCH;
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const n     = context.issue.number;
            const compareUrl = `https://github.com/${owner}/${repo}/compare/main...${encodeURIComponent(head)}?expand=1`;
            const prBody = [
              'ì´ìŠˆ ë¼ë²¨ íŠ¸ë¦¬ê±°ë¡œ ìë™ ìƒì„±ëœ ADR ì´ˆì•ˆì…ë‹ˆë‹¤. ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.',
              '',
              `Closes #${n}`
            ].join('\n');

            try {
              const { data: pr } = await github.rest.pulls.create({
                owner, repo, title: `ADR: ${head}`, head, base: 'main', body: prBody
              });
              core.info(`PR #${pr.number} opened`);
            } catch (e) {
              core.warning(`PR auto-create failed: ${e.message}`);
              await github.rest.issues.createComment({
                owner, repo, issue_number: n,
                body: [
                  'ğŸ”’ PR ìë™ ìƒì„±ì´ ì°¨ë‹¨ë˜ì–´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                  `ë¸Œëœì¹˜ëŠ” ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤: \`${head}\`.`,
                  `â¡ï¸ [ì—¬ê¸°](${compareUrl})ë¥¼ ëˆŒëŸ¬ ìˆ˜ë™ìœ¼ë¡œ PRì„ ì—´ì–´ì£¼ì„¸ìš”.`,
                  '',
                  `PR ë³¸ë¬¸ì— \`Closes #${n}\`ë¥¼ í¬í•¨í•˜ë©´ ë¨¸ì§€ ì‹œ ì´ìŠˆê°€ ìë™ ì¢…ë£Œë©ë‹ˆë‹¤.`
                ].join('\n')
              });
            }
        env:
          BRANCH: ${{ steps.x.outputs.branch }}
